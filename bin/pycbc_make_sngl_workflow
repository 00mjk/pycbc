#!/usr/bin/env python

# Copyright (C) 2015 Christopher M. Biwer
#
# This program is free software; you can redistribute it and/or modify it
# under the terms of the GNU General Public License as published by the
# Free Software Foundation; either version 3 of the License, or (at your
# option) any later version.
#
# This program is distributed in the hope that it will be useful, but
# WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General
# Public License for more details.
#
# You should have received a copy of the GNU General Public License along
# with this program; if not, write to the Free Software Foundation, Inc.,
# 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA.

import pycbc
import pycbc.version

import os
import copy
import logging
import urlparse
import argparse
import lal
import Pegasus.DAX3 as dax
from glue import segments
import pycbc.workflow as _workflow

################
# setup workflow
################

# read command line
parser = argparse.ArgumentParser(usage='pycbc_make_sngl_workflow \
[--options]',
                                 description="Workflow generator for a \
                                 single detector analysis.")
parser.add_argument("--name", type=str, required=True,
                    help="Descriptive name of the analysis.")
_workflow.add_workflow_command_line_group(parser)
args = parser.parse_args()

# setup log
logging.basicConfig(format='%(asctime)s:%(levelname)s : %(message)s',
                    level=logging.INFO,datefmt='%I:%M:%S')

# directory names
runDir = os.path.join(os.getcwd(), args.name)
datafindDir = runDir + '/datafind'
fulldataDir = runDir + '/full_data'
htmlDir = runDir + '/output'
segDir = htmlDir + '/segments'

# change into run dir
if not os.path.exists(runDir):
  os.makedirs(runDir)
os.chdir(runDir)

# setup workflow
workflow = _workflow.Workflow(args, args.name)

####################################
# retreieve segments and frame files
####################################

# get segments
scienceSegs, segFileList = _workflow.setup_segment_generation(workflow, segDir)

# get frames
datafinds, scienceSegs = _workflow.setup_datafind_workflow(workflow, scienceSegs,
                           datafindDir, segFileList)

###########################
# setup template bank nodes
###########################

# setup template bank
banks = _workflow.setup_tmpltbank_workflow(workflow, scienceSegs, datafinds, 
                                       datafindDir)

# setup splitbank
splitBanks = _workflow.setup_splittable_workflow(workflow, banks, datafindDir)

###############################
# setup matched filtering nodes
###############################

# setup matched filtering
insps = _workflow.setup_matchedfltr_workflow(workflow, scienceSegs, datafinds,
                                         splitBanks, fulldataDir)

########################
# setup ligolw_add nodes
########################

# setup ligolw_add executable
llwadd_exe = _workflow.LigolwAddExecutable(workflow.cp, 'llwadd',
                                   ifo=''.join(scienceSegs.keys()),
                                   out_dir=fulldataDir)

# group inspiral files by IFO and loop over IFOs
insps_ifos, insps_ifos_filelists = insps.categorize_by_attr('ifo')
for insps_ifo, insps_ifo_filelist in zip(insps_ifos, insps_ifos_filelists):

    # group IFO inspiral files by valid segments and loop over valid segments
    insps_segs, insps_seg_filelists = insps_ifo_filelist.categorize_by_attr('segment')
    for insps_seg, insps_seg_filelist in zip(insps_segs, insps_seg_filelists): 

        # setup ligolw_add nodes for inspiral filelists of identical IFO and valid segment
        llwadd_file = _workflow.File(insps_ifo, 'LLWADD_UNCLUSTERED', insps_seg,
                                     directory=fulldataDir, extension='xml.gz')
        llwadd_node = llwadd_exe.create_node(insps_seg, insps_seg_filelist,
                                             output=llwadd_file) 
        llwadd_node.add_opt('--lfn-start-time', insps_seg[0])
        llwadd_node.add_opt('--lfn-end-time',insps_seg[1])
        workflow.add_node(llwadd_node)

######################
# setup plotting nodes
######################


# save
workflow.save()
logging.info('Finished.')
