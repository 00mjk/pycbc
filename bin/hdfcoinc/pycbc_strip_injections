#!/bin/env python
import numpy, argparse, pycbc.version, logging
from pycbc.events import veto
from glue.ligolw import ligolw, table, lsctables, utils as ligolw_utils

def remove(l, i):
    to_remove = [l[t] for t in i]
    for r in to_remove:
        l.remove(r)

# dummy class needed for loading LIGOLW files
class LIGOLWContentHandler(ligolw.LIGOLWContentHandler):
    pass
lsctables.use_in(LIGOLWContentHandler)

parser = argparse.ArgumentParser()
parser.add_argument('--version', action='version', version=pycbc.version.git_verbose_msg)
parser.add_argument('--verbose', action='store_true')
parser.add_argument('--injection-file')
parser.add_argument('--veto-file', 
                      help="File containing segments used to veto injections")
parser.add_argument('--segment-name', 
                      help="Name of segmentlist within the veto file to veto injections")
parser.add_argument('--ifos', nargs='+')
parser.add_argument('--output-file')
args = parser.parse_args()
pycbc.init_logging(args.verbose)

logging.info('File: %s' % args.injection_file)
indoc = ligolw_utils.load_filename(args.injection_file, False, contenthandler=LIGOLWContentHandler)
sim_table = table.get_table(indoc, 'sim_inspiral')

logging.info('%s Injections in file' % len(sim_table))

logging.info('Removing injections outside coincident time')
for ifo in args.ifos:    
    inj_time = numpy.array(sim_table.get_column('geocent_end_time') + 1e-9 * sim_table.get_column('geocent_end_time_ns'), dtype=numpy.float64)
    idx, segs = veto.indices_outside_segments(inj_time, [args.veto_file], ifo, args.segment_name)
    remove(sim_table, idx)
logging.info('We now have %s injections' % len(sim_table))

outdoc = ligolw.Document()
outdoc.appendChild(ligolw.LIGO_LW()).appendChild(sim_table)
ligolw_utils.write_filename(outdoc, args.output_file)
logging.info('Done')    
